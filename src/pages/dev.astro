---
import Layout from "@/layouts/Layout.astro";
import NavBar from "@/components/NavBar.tsx";
import DevCard from "@/components/DevCard.astro";
import { getCollection, type CollectionEntry } from "astro:content";

export const prerender = true;

// Base type
type DevEntry = CollectionEntry<"dev">;

// Type guards
function isProject(
  entry: DevEntry,
): entry is DevEntry & { data: { type: "project"; date: Date } } {
  return entry.data.type === "project";
}

function isAbout(
  entry: DevEntry,
): entry is DevEntry & {
  data: {
    type: "about";
    frontend?: string[];
    backend?: string[];
    cloud?: string[];
  };
} {
  return entry.data.type === "about";
}

// Get entries
const devEntries = await getCollection("dev");

// Narrow entries
const aboutEntry = devEntries.find(isAbout);
const projects = devEntries.filter(isProject);

// Sort projects
const sortedProjects = projects.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

// Access skills safely
const frontend = aboutEntry?.data.frontend ?? [];
const backend = aboutEntry?.data.backend ?? [];
const cloud = aboutEntry?.data.cloud ?? [];
---

<Layout>
  <NavBar client:load />

  <!-- About + Skills Combined -->
  <section
    class="max-w-5xl mx-auto px-4 mt-12 mb-24 grid md:grid-cols-2 gap-12 items-start"
  >
    <!-- About Text -->
    <div>
      <h1 class="text-4xl font-bold text-neutral-100 mb-4">Development Work</h1>
      <p class="text-neutral-400 text-lg">
        {
          aboutEntry?.data.description ??
            "A collection of practical tools and sites Iâ€™ve built using modern web technologies."
        }
      </p>
    </div>

    <!-- Skills List -->
    <div class="space-y-8">
      <div>
        <h3 class="text-lg font-semibold text-neutral-100 mb-2">Frontend</h3>
        <ul class="flex flex-wrap gap-2">
          {
            frontend.map((tech) => (
              <li class="bg-neutral-900 text-neutral-300 px-3 py-1 text-sm border border-neutral-700 rounded-full">
                {tech}
              </li>
            ))
          }
        </ul>
      </div>

      <div>
        <h3 class="text-lg font-semibold text-neutral-100 mb-2">Backend</h3>
        <ul class="flex flex-wrap gap-2">
          {
            backend.map((tech) => (
              <li class="bg-neutral-900 text-neutral-300 px-3 py-1 text-sm border border-neutral-700 rounded-full">
                {tech}
              </li>
            ))
          }
        </ul>
      </div>

      <div>
        <h3 class="text-lg font-semibold text-neutral-100 mb-2">
          Cloud & DevOps
        </h3>
        <ul class="flex flex-wrap gap-2">
          {
            cloud.map((tech) => (
              <li class="bg-neutral-900 text-neutral-300 px-3 py-1 text-sm border border-neutral-700 rounded-full">
                {tech}
              </li>
            ))
          }
        </ul>
      </div>
    </div>
  </section>

<!-- Projects List -->
<section class="bg-neutral-950 p-10 m-10 max-w-5xl mx-auto px-4 grid gap-8 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 pb-32">
  {sortedProjects.map((project) => <DevCard project={project} />)}
</section>
</Layout>
